sudo: required
dist: trusty
language: node_js
node_js:
  - "4"
services:
  - docker
before_install:
  - export CHROME_BIN=chromium-browser
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start
install:
  - docker version
  # Update docker-compose via pip
  - sudo pip install docker-compose
  - docker-compose version
  - git submodule init
  - git submodule update
  # NodeJS Install
  - "npm install"
  # Update public certs
  - sudo update-ca-certificates --verbose
  # Pull images
  - docker-compose -f firefly-stack.yml pull
  - docker-compose -f project-daemon/user-stacks/basic-stack.yml pull
addons:
  hosts:
    - local.montage.studio
before_script:
  - export DOCKER_CLIENT_TIMEOUT=120
  - npm run generate-local-certificate
  - docker swarm init
  - npm start
script:
  - npm run lint
  - sleep 30
  - docker service ls
  - docker service ps firefly_traefik
  - docker ps
  - docker ps | grep -q firefly_traefik
  - docker ps | grep -q firefly_login
  - docker ps | grep -q firefly_static
  - docker ps | grep -q firefly_project-daemon
  - runSlowSpecs=true npm test
after_script:
  - npm stop
  - docker swarm leave --force
