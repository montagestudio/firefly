# this config needs haproxy-1.1.28 or haproxy-1.2.1

global
	log 127.0.0.1	local0
	log 127.0.0.1	local1 notice
	#log loghost	local0 info
	maxconn 4096
	#chroot /usr/share/haproxy
	user haproxy
	group haproxy
	daemon
	#debug
	#quiet

defaults
	log	global
	mode	http
	option	httplog
	option	dontlognull
	retries	3
	option redispatch
	option http-server-close
	maxconn	2000
	contimeout	5000
	clitimeout	50000
	srvtimeout	50000
	stats enable
    stats auth  montage:Mont@ge1789


frontend http-in
	bind *:80
	bind *:2440
	option http-server-close
	option http-pretend-keepalive
	acl static path_beg /app
	acl static path_beg /assets
	acl static path /favicon.ico
	acl project path_beg /api
	acl project hdr_end(Host) local-project.montagestudio.com:2440
	acl is_websocket hdr(Upgrade) -i WebSocket
	# `use_backend project` needs to go first because there might be urls like
	# /assets that should be handled by the project server instead of the
	# static server
	use_backend project if project or is_websocket
	use_backend static if static
	default_backend login

#
# Login servers
#
backend login
	balance roundrobin
	option httpchk
	stats admin if TRUE
	cookie login insert postonly
	server login1 107.170.4.128:2440 cookie L1 maxconn 1000 check
	server login2 107.170.4.142:2440 cookie L2 maxconn 1000 check

#
# Web servers for filament
#
backend static
	balance roundrobin
	stats admin if TRUE
	# Replace requests to /favicon.ico with /app/assets/img/favicon.ico
	reqirep ^([A-Z]*)\ /favicon.ico\ (.*)$		\1\ /app/assets/img/favicon.ico\ \2
	# Replace requests to /assets with /app/assets
	reqirep ^([A-Z]*)\ (/assets[^\ ]*)\ (.*)$		\1\ /app\2\ \3
	server static1 162.243.35.210:80 maxconn 1000
	# server static2 192.168.2.2:80 maxconn 1000


#
# Project servers
#
backend project
	balance roundrobin
	timeout server 120000
	option httpchk
	stats admin if TRUE
	cookie project indirect preserve
	server project1 192.168.5.1:2440  cookie P1 maxconn 1000 check
	server project2 192.168.5.2:2440  cookie P2 maxconn 1000 check
	server project3 192.168.5.3:2440  cookie P3 maxconn 1000 check
	server project4 192.168.5.4:2440  cookie P4 maxconn 1000 check




# listen	appli1-rewrite 0.0.0.0:10001
# 	cookie	SERVERID rewrite
# 	balance	roundrobin
# 	server	app1_1 192.168.34.23:8080 cookie app1inst1 check inter 2000 rise 2 fall 5
# 	server	app1_2 192.168.34.32:8080 cookie app1inst2 check inter 2000 rise 2 fall 5
# 	server	app1_3 192.168.34.27:8080 cookie app1inst3 check inter 2000 rise 2 fall 5
# 	server	app1_4 192.168.34.42:8080 cookie app1inst4 check inter 2000 rise 2 fall 5
#
# listen	appli2-insert 0.0.0.0:10002
# 	option	httpchk
# 	balance	roundrobin
# 	cookie	SERVERID insert indirect nocache
# 	server	inst1 192.168.114.56:80 cookie server01 check inter 2000 fall 3
# 	server	inst2 192.168.114.56:81 cookie server02 check inter 2000 fall 3
# 	capture cookie vgnvisitor= len 32
#
# 	option	httpclose		# disable keep-alive
# 	rspidel ^Set-cookie:\ IP=	# do not let this cookie tell our internal IP address
#
# listen	appli3-relais 0.0.0.0:10003
# 	dispatch 192.168.135.17:80
#
# listen	appli4-backup 0.0.0.0:10004
# 	option	httpchk /index.html
# 	option	persist
# 	balance	roundrobin
# 	server	inst1 192.168.114.56:80 check inter 2000 fall 3
# 	server	inst2 192.168.114.56:81 check inter 2000 fall 3 backup
#
# listen	ssl-relay 0.0.0.0:8443
# 	option	ssl-hello-chk
# 	balance	source
# 	server	inst1 192.168.110.56:443 check inter 2000 fall 3
# 	server	inst2 192.168.110.57:443 check inter 2000 fall 3
# 	server	back1 192.168.120.58:443 backup
#
# listen	appli5-backup 0.0.0.0:10005
# 	option	httpchk *
# 	balance	roundrobin
# 	cookie	SERVERID insert indirect nocache
# 	server	inst1 192.168.114.56:80 cookie server01 check inter 2000 fall 3
# 	server	inst2 192.168.114.56:81 cookie server02 check inter 2000 fall 3
# 	server	inst3 192.168.114.57:80 backup check inter 2000 fall 3
# 	capture cookie ASPSESSION len 32
# 	srvtimeout	20000
#
# 	option	httpclose		# disable keep-alive
# 	option  checkcache		# block response if set-cookie & cacheable
#
# 	rspidel ^Set-cookie:\ IP=	# do not let this cookie tell our internal IP address
#
	#errorloc	502	http://192.168.114.58/error502.html
	errorfile	400	/etc/haproxy/errors/400.http
	errorfile	403	/etc/haproxy/errors/403.http
	errorfile	408	/etc/haproxy/errors/408.http
	errorfile	500	/etc/haproxy/errors/500.http
	errorfile	502	/etc/haproxy/errors/502.http
	errorfile	503	/etc/haproxy/errors/503.http
	errorfile	504	/etc/haproxy/errors/504.http
